{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}
    {% if form.instance.pk %}
        Editar Factura
    {% else %}
        Nueva Factura
    {% endif %} - SettEstate
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'index' %}">Inicio</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'factura:factura_list' %}">Facturas</a></li>
                    <li class="breadcrumb-item active">
                        {% if form.instance.pk %}Editar{% else %}Nueva{% endif %} Factura
                    </li>
                </ol>
            </nav>

            <!-- Card principal -->
            <div class="card shadow-lg border-0 rounded-lg">
                <div class="card-header bg-gradient-primary-to-secondary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-file-invoice-dollar me-2"></i>
                            {% if form.instance.pk %}Editar{% else %}Nueva{% endif %} Factura
                        </h3>
                        {% if form.instance.pk %}
                        <div class="d-flex align-items-center">
                            <span class="badge bg-light text-dark me-2">ID: {{ form.instance.pk }}</span>
                            <span class="badge 
                                {% if form.instance.estado == 'BORRADOR' %}bg-secondary
                                {% elif form.instance.estado == 'EMITIDA' %}bg-primary
                                {% elif form.instance.estado == 'PAGADA' %}bg-success
                                {% else %}bg-danger{% endif %}">
                                {{ form.instance.get_estado_display }}
                            </span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <form method="post" class="needs-validation" novalidate>
                    {% csrf_token %}
                    
                    <div class="card-body">
                        <!-- Sistema de pestañas -->
                        <ul class="nav nav-tabs" id="facturaTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="datos-basicos-tab" data-bs-toggle="tab" data-bs-target="#datos-basicos" type="button" role="tab" aria-controls="datos-basicos" aria-selected="true">
                                    <i class="fas fa-info-circle me-1"></i> Datos Básicos
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="items-tab" data-bs-toggle="tab" data-bs-target="#items" type="button" role="tab" aria-controls="items" aria-selected="false">
                                    <i class="fas fa-list me-1"></i> Ítems
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="resumen-tab" data-bs-toggle="tab" data-bs-target="#resumen" type="button" role="tab" aria-controls="resumen" aria-selected="false">
                                    <i class="fas fa-chart-pie me-1"></i> Resumen
                                </button>
                            </li>
                        </ul>
                        
                        <!-- Contenido de las pestañas -->
                        <div class="tab-content pt-4" id="facturaTabsContent">
                            <!-- Datos Básicos -->
                            <div class="tab-pane fade show active" id="datos-basicos" role="tabpanel" aria-labelledby="datos-basicos-tab">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.contrato.id_for_label }}" class="form-label fw-bold">Contrato</label>
                                            {{ form.contrato }}
                                            {% if form.contrato.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.contrato.errors|join:", " }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.fecha_vencimiento.id_for_label }}" class="form-label fw-bold">Fecha de Vencimiento</label>
                                            {{ form.fecha_vencimiento }}
                                            {% if form.fecha_vencimiento.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.fecha_vencimiento.errors|join:", " }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="{{ form.estado.id_for_label }}" class="form-label fw-bold">Estado</label>
                                            {{ form.estado }}
                                            {% if form.estado.errors %}
                                                <div class="invalid-feedback d-block">
                                                    {{ form.estado.errors|join:", " }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        {% if form.instance.pk %}
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Número de Factura</label>
                                            <input type="text" class="form-control" value="{{ form.instance.numero }}" readonly>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Información del contrato seleccionado -->
                                <div id="contrato-info" class="mt-4 p-3 bg-light rounded shadow-sm" style="display: none;">
                                    <h5 class="mb-3">
                                        <i class="fas fa-file-contract me-2 text-primary"></i>
                                        Información del Contrato
                                    </h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>Propiedad:</strong> <span id="contrato-propiedad"></span></p>
                                            <p><strong>Inquilino:</strong> <span id="contrato-inquilino"></span></p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>Fecha de inicio:</strong> <span id="contrato-inicio"></span></p>
                                            <p><strong>Fecha de fin:</strong> <span id="contrato-fin"></span></p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Fechas de creación y modificación -->
                                {% if form.instance.pk %}
                                <div class="row mt-4">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Fecha de creación</label>
                                            <input type="text" class="form-control" value="{{ form.instance.creacion|date:'d/m/Y H:i' }}" readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Última modificación</label>
                                            <input type="text" class="form-control" value="{{ form.instance.modificacion|date:'d/m/Y H:i' }}" readonly>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Ítems -->
                            <div class="tab-pane fade" id="items" role="tabpanel" aria-labelledby="items-tab">
                                <!-- Importante: incluir el management_form -->
                                {{ formset.management_form }}
                                
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h4 class="mb-0">
                                        <i class="fas fa-list-ul me-2"></i>
                                        Ítems de la factura
                                    </h4>
                                    <button type="button" id="add-item" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-plus me-1"></i> Agregar Ítem
                                    </button>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="item-table">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Tipo</th>
                                                <th>Descripción</th>
                                                <th>Monto</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for form in formset %}
                                            <tr class="item-form">
                                                <td>
                                                    {{ form.tipo }}
                                                    {% if form.tipo.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.tipo.errors|join:", " }}
                                                    </div>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {{ form.descripcion }}
                                                    {% if form.descripcion.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.descripcion.errors|join:", " }}
                                                    </div>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {{ form.monto }}
                                                    {% if form.monto.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.monto.errors|join:", " }}
                                                    </div>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <div class="d-flex">
                                                        {% if formset.can_delete %}
                                                        <div class="form-check">
                                                            {{ form.DELETE }}
                                                            <label class="form-check-label text-danger" for="{{ form.DELETE.id_for_label }}">
                                                                <i class="fas fa-trash-alt"></i>
                                                            </label>
                                                        </div>
                                                        {% endif %}
                                                        <button type="button" class="btn btn-sm btn-outline-danger ms-2 remove-form">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            <!-- Importante: incluir campos ocultos -->
                                            {% for hidden in form.hidden_fields %}
                                                {{ hidden }}
                                            {% endfor %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Alerta si no hay ítems -->
                                <div id="no-items-alert" class="alert alert-warning {% if formset|length > 0 %}d-none{% endif %}">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    No hay ítems en esta factura. Agregue al menos un ítem.
                                </div>
                            </div>
                            
                            <!-- Resumen -->
                            <div class="tab-pane fade" id="resumen" role="tabpanel" aria-labelledby="resumen-tab">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-body">
                                                <h5 class="card-title">
                                                    <i class="fas fa-info-circle me-2 text-primary"></i>
                                                    Información de la Factura
                                                </h5>
                                                <ul class="list-group list-group-flush">
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        <span>Contrato:</span>
                                                        <span id="resumen-contrato" class="fw-bold"></span>
                                                    </li>
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        <span>Fecha de Emisión:</span>
                                                        <span id="resumen-emision" class="fw-bold">
                                                            {% if form.instance.fecha_emision %}
                                                                {{ form.instance.fecha_emision|date:"d/m/Y" }}
                                                            {% else %}
                                                                Hoy
                                                            {% endif %}
                                                        </span>
                                                    </li>
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        <span>Fecha de Vencimiento:</span>
                                                        <span id="resumen-vencimiento" class="fw-bold"></span>
                                                    </li>
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        <span>Estado:</span>
                                                        <span id="resumen-estado" class="fw-bold"></span>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-body">
                                                <h5 class="card-title">
                                                    <i class="fas fa-calculator me-2 text-primary"></i>
                                                    Resumen de Ítems
                                                </h5>
                                                <div class="table-responsive">
                                                    <table class="table table-sm">
                                                        <thead>
                                                            <tr>
                                                                <th>Tipo</th>
                                                                <th class="text-end">Monto</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="resumen-items">
                                                            <!-- Se llenará con JavaScript -->
                                                        </tbody>
                                                        <tfoot>
                                                            <tr class="table-light">
                                                                <th>Total</th>
                                                                <th class="text-end" id="resumen-total">$0.00</th>
                                                            </tr>
                                                        </tfoot>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Gráfico de distribución -->
                                <div class="card border-0 shadow-sm mt-4">
                                    <div class="card-body">
                                        <h5 class="card-title">
                                            <i class="fas fa-chart-pie me-2 text-primary"></i>
                                            Distribución de Ítems
                                        </h5>
                                        <div class="row">
                                            <div class="col-md-8">
                                                <canvas id="items-chart" height="200"></canvas>
                                            </div>
                                            <div class="col-md-4">
                                                <div id="chart-legend" class="mt-3"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-footer bg-light">
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'factura:factura_list' %}" 
                               class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i> Volver
                            </a>
                            <div>
                                {% if form.instance.pk and form.instance.es_editable %}
                                <button type="button" id="btn-emitir" class="btn btn-success me-2">
                                    <i class="fas fa-paper-plane me-1"></i> Emitir Factura
                                </button>
                                {% endif %}
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i>
                                    {% if form.instance.pk %}
                                        Actualizar Factura
                                    {% else %}
                                        Crear Factura
                                    {% endif %}
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Tarjeta de ayuda -->
            <div class="card mt-4 border-0 shadow-sm bg-light">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-lightbulb text-warning me-2"></i>
                        Consejos para completar el formulario
                    </h5>
                    <ul class="mb-0">
                        <li>Seleccione un contrato activo para generar la factura.</li>
                        <li>Agregue todos los ítems necesarios (alquiler, expensas, servicios, etc.).</li>
                        <li>Verifique el total antes de guardar o emitir la factura.</li>
                        <li>Una vez emitida, la factura no podrá ser modificada.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
    
{% endblock %}
    

{% block extra_css %}
<style>
    /* Estilos para el formulario */
    .bg-gradient-primary-to-secondary {
        background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
    }
    
    .invalid-feedback {
        display: block;
    }
    
    /* Estilos para las pestañas */
    .nav-tabs {
        border-bottom: 1px solid #dee2e6;
    }
    
    .nav-tabs .nav-link {
        border: none;
        color: #495057;
        font-weight: 500;
        padding: 1rem 1.5rem;
        margin-bottom: -1px;
        transition: all 0.2s ease;
    }
    
    .nav-tabs .nav-link:hover {
        color: #3498db;
        border-bottom: 3px solid #e9ecef;
    }
    
    .nav-tabs .nav-link.active {
        color: #3498db;
        border-bottom: 3px solid #3498db;
        background-color: transparent;
    }
    
    .tab-content {
        padding: 1.5rem 0;
    }
    
    /* Mejoras para campos pequeños */
    .form-group {
        margin-bottom: 1rem;
    }
    
    /* Campos de tipo checkbox con mejor alineación */
    .form-check {
        display: flex;
        align-items: center;
        height: 100%;
    }
    
    .form-check-input {
        margin-top: 0;
    }
    
    /* Animaciones */
    .card, .btn {
        transition: all 0.3s ease;
    }
    
    .btn:hover {
        transform: translateY(-2px);
    }
    
    /* Estilos para las fechas de creación/modificación */
    .form-control[readonly] {
        background-color: #f8f9fa;
        cursor: default;
    }
    
    /* Animación para cambio de pestañas */
    .tab-pane.fade {
        transition: opacity 0.15s linear;
    }
    
    /* Estilos para la tabla de ítems */
    #item-table {
        border-collapse: separate;
        border-spacing: 0;
    }
    
    #item-table thead th {
        background-color: #f8f9fa;
        border-top: none;
    }
    
    .item-form {
        transition: all 0.3s ease;
    }
    
    .item-form:hover {
        background-color: #f8f9fa;
    }
    
    /* Estilos para las tarjetas de información */
    #contrato-info {
        transition: all 0.3s ease;
    }
    
    /* Estilos para el gráfico */
    #items-chart {
        max-height: 300px;
    }
    
    /* Estilos para el botón de eliminar */
    .remove-form {
        opacity: 0.7;
        transition: all 0.2s ease;
    }
    
    .remove-form:hover {
        opacity: 1;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Manejo de pestañas
    const triggerTabList = document.querySelectorAll('#facturaTabs button');
    triggerTabList.forEach(triggerEl => {
        triggerEl.addEventListener('click', event => {
            event.preventDefault();
            const tab = new bootstrap.Tab(triggerEl);
            tab.show();
            
            // Guardar la pestaña activa en localStorage
            localStorage.setItem('activeFacturaTab', triggerEl.getAttribute('id'));
            
            // Si se selecciona la pestaña de resumen, actualizar los datos
            if (triggerEl.id === 'resumen-tab') {
                actualizarResumen();
            }
        });
    });

    // Restaurar la pestaña activa al cargar la página
    const activeTab = localStorage.getItem('activeFacturaTab');
    if (activeTab) {
        const tabToActivate = document.getElementById(activeTab);
        if (tabToActivate) {
            const tab = new bootstrap.Tab(tabToActivate);
            tab.show();
            
            // Si se restaura la pestaña de resumen, actualizar los datos
            if (activeTab === 'resumen-tab') {
                actualizarResumen();
            }
        }
    }
    
    // Si hay errores en el formulario, activar la pestaña correspondiente
    const formErrors = document.querySelectorAll('.invalid-feedback.d-block');
    if (formErrors.length > 0) {
        // Encontrar la pestaña que contiene el primer error
        const firstError = formErrors[0];
        const tabPane = firstError.closest('.tab-pane');
        if (tabPane) {
            const tabId = tabPane.id;
            const tabToActivate = document.querySelector(`[data-bs-target="#${tabId}"]`);
            if (tabToActivate) {
                const tab = new bootstrap.Tab(tabToActivate);
                tab.show();
            }
        }
    }
    
    // Manejo del formset de ítems
    const addButton = document.getElementById('add-item');
    
    // Detectar el prefijo del formset automáticamente
    const formsetPrefix = document.querySelector('.item-form input, .item-form select')?.name.split('-')[0] || 'form';
    const totalForms = document.getElementById(`id_${formsetPrefix}-TOTAL_FORMS`);
    
    if (!totalForms) {
        console.error(`No se encontró el campo TOTAL_FORMS. Formset prefix: "${formsetPrefix}"`);
    } else {
        // Función para actualizar los índices de los formularios
        function updateElementIndex(el, ndx) {
            const prefix = formsetPrefix;
            const id_regex = new RegExp('(' + prefix + '-\\d+)');
            const replacement = prefix + '-' + ndx;
            
            if (el.id) el.id = el.id.replace(id_regex, replacement);
            if (el.name) el.name = el.name.replace(id_regex, replacement);
            
            // Actualizar también los atributos for de las etiquetas
            if (el.hasAttribute('for')) {
                el.setAttribute('for', el.getAttribute('for').replace(id_regex, replacement));
            }
        }
        
        // Función para clonar un formulario
        addButton.addEventListener('click', function(e) {
            e.preventDefault();
            
            const formCount = parseInt(totalForms.value);
            const templateRow = document.querySelector('.item-form');
            
            if (!templateRow) {
                console.error("No se encontró la plantilla de fila para clonar");
                return;
            }
            
            const row = templateRow.cloneNode(true);
            
            // Limpiar los valores del formulario clonado
            row.querySelectorAll('input, select').forEach(function(input) {
                if (input.type !== 'checkbox') {
                    input.value = '';
                } else {
                    input.checked = false;
                }
                
                // Actualizar los índices
                updateElementIndex(input, formCount);
            });
            
            // Agregar botón de eliminar al nuevo formulario
            const deleteButton = row.querySelector('.remove-form');
            if (deleteButton) {
                deleteButton.addEventListener('click', function() {
                    row.remove();
                    updateTotalForms();
                    actualizarNoItemsAlert();
                });
            }
            
            // Insertar el nuevo formulario en la tabla
            document.querySelector('#item-table tbody').appendChild(row);
            
            // Actualizar el contador de formularios
            totalForms.value = formCount + 1;
            
            // Ocultar la alerta de no ítems
            actualizarNoItemsAlert();
            
            // Animar la entrada del nuevo formulario
            row.style.opacity = '0';
            setTimeout(() => {
                row.style.opacity = '1';
            }, 10);
        });
        
        // Configurar botones de eliminar existentes
        document.querySelectorAll('.remove-form').forEach(function(button) {
            button.addEventListener('click', function() {
                button.closest('.item-form').remove();
                updateTotalForms();
                actualizarNoItemsAlert();
            });
        });
        
        // Función para actualizar el contador de formularios después de eliminar
        function updateTotalForms() {
            const forms = document.querySelectorAll('.item-form');
            totalForms.value = forms.length;
            
            // Reindexar los formularios
            forms.forEach((form, index) => {
                form.querySelectorAll('input, select').forEach(input => {
                    updateElementIndex(input, index);
                });
            });
        }
        
        // Función para actualizar la alerta de no ítems
        function actualizarNoItemsAlert() {
            const forms = document.querySelectorAll('.item-form');
            const noItemsAlert = document.getElementById('no-items-alert');
            
            if (forms.length === 0) {
                noItemsAlert.classList.remove('d-none');
            } else {
                noItemsAlert.classList.add('d-none');
            }
        }
    }
    
    // Cargar información del contrato
    const contratoSelect = document.getElementById('{{ form.contrato.id_for_label }}');
    
    // Datos de contratos (esto debería venir del backend)
    const contratosData = {{ contratos_data|default:'{}' }};
    
    contratoSelect.addEventListener('change', function() {
        const contratoId = this.value;
        const contratoInfo = document.getElementById('contrato-info');
        
        if (contratoId && contratosData[contratoId]) {
            const contrato = contratosData[contratoId];
            document.getElementById('contrato-propiedad').textContent = contrato.propiedad;
            document.getElementById('contrato-inquilino').textContent = contrato.inquilino;
            document.getElementById('contrato-inicio').textContent = contrato.fecha_inicio;
            document.getElementById('contrato-fin').textContent = contrato.fecha_fin;
            
            contratoInfo.style.display = 'block';
            
            // Sugerir ítems basados en el contrato
            sugerirItems(contrato);
        } else {
            contratoInfo.style.display = 'none';
        }
    });
    
    // Función para sugerir ítems basados en el contrato
    function sugerirItems(contrato) {
        // Si no hay ítems, sugerir el alquiler automáticamente
        const items = document.querySelectorAll('.item-form');
        if (items.length === 0 || (items.length === 1 && !items[0].querySelector('select').value)) {
            // Si hay un solo ítem vacío, usarlo
            if (items.length === 1) {
                const tipoSelect = items[0].querySelector('select');
                const descripcionInput = items[0].querySelector('input[name*="descripcion"]');
                const montoInput = items[0].querySelector('input[name*="monto"]');
                
                if (tipoSelect && descripcionInput && montoInput) {
                    tipoSelect.value = 'ALQUILER';
                    descripcionInput.value = `Alquiler mensual - ${contrato.propiedad}`;
                    montoInput.value = contrato.precio_alquiler || '';
                }
            } else {
                // Si no hay ítems, agregar uno nuevo
                addButton.click();
                setTimeout(() => {
                    const newItem = document.querySelector('.item-form:last-child');
                    const tipoSelect = newItem.querySelector('select');
                    const descripcionInput = newItem.querySelector('input[name*="descripcion"]');
                    const montoInput = newItem.querySelector('input[name*="monto"]');
                    
                    if (tipoSelect && descripcionInput && montoInput) {
                        tipoSelect.value = 'ALQUILER';
                        descripcionInput.value = `Alquiler mensual - ${contrato.propiedad}`;
                        montoInput.value = contrato.precio_alquiler || '';
                    }
                }, 100);
            }
            
            // Si hay expensas en el contrato, agregar otro ítem
            if (contrato.expensas && parseFloat(contrato.expensas) > 0) {
                addButton.click();
                setTimeout(() => {
                    const newItem = document.querySelector('.item-form:last-child');
                    const tipoSelect = newItem.querySelector('select');
                    const descripcionInput = newItem.querySelector('input[name*="descripcion"]');
                    const montoInput = newItem.querySelector('input[name*="monto"]');
                    
                    if (tipoSelect && descripcionInput && montoInput) {
                        tipoSelect.value = 'EXPENSAS';
                        descripcionInput.value = `Expensas - ${contrato.propiedad}`;
                        montoInput.value = contrato.expensas || '';
                    }
                }, 200);
            }
        }
    }
    
    // Función para actualizar el resumen
    function actualizarResumen() {
        // Actualizar información básica
        const contratoSelect = document.getElementById('{{ form.contrato.id_for_label }}');
        const fechaVencimiento = document.getElementById('{{ form.fecha_vencimiento.id_for_label }}');
        const estadoSelect = document.getElementById('{{ form.estado.id_for_label }}');
        
        // Actualizar información del contrato en el resumen
        if (contratoSelect.value && contratosData[contratoSelect.value]) {
            document.getElementById('resumen-contrato').textContent = contratosData[contratoSelect.value].nombre || contratoSelect.options[contratoSelect.selectedIndex].text;
        } else {
            document.getElementById('resumen-contrato').textContent = 'No seleccionado';
        }
        
        // Actualizar fecha de vencimiento
        if (fechaVencimiento.value) {
            const fecha = new Date(fechaVencimiento.value);
            document.getElementById('resumen-vencimiento').textContent = fecha.toLocaleDateString('es-ES', { day: '2-digit', month: 'long', year: 'numeric' });
        } else {
            document.getElementById('resumen-vencimiento').textContent = 'No establecida';
        }
        
        // Actualizar estado
        if (estadoSelect.value) {
            const estadoText = estadoSelect.options[estadoSelect.selectedIndex].text;
            let badgeClass = '';
            
            switch (estadoSelect.value) {
                case 'BORRADOR':
                    badgeClass = 'bg-secondary';
                    break;
                case 'EMITIDA':
                    badgeClass = 'bg-primary';
                    break;
                case 'PAGADA':
                    badgeClass = 'bg-success';
                    break;
                case 'ANULADA':
                    badgeClass = 'bg-danger';
                    break;
                default:
                    badgeClass = 'bg-secondary';
            }
            
            document.getElementById('resumen-estado').innerHTML = `<span class="badge ${badgeClass}">${estadoText}</span>`;
        } else {
            document.getElementById('resumen-estado').textContent = 'No establecido';
        }
        
        // Actualizar resumen de ítems
        const itemForms = document.querySelectorAll('.item-form');
        const resumenItems = document.getElementById('resumen-items');
        resumenItems.innerHTML = '';
        
        let total = 0;
        const itemsData = [];
        
        itemForms.forEach(form => {
            const tipoSelect = form.querySelector('select[name*="tipo"]');
            const montoInput = form.querySelector('input[name*="monto"]');
            const deleteCheckbox = form.querySelector('input[type="checkbox"][name*="DELETE"]');
            
            // Si el ítem está marcado para eliminar o no tiene tipo o monto, no lo incluimos
            if (deleteCheckbox && deleteCheckbox.checked) return;
            if (!tipoSelect || !tipoSelect.value || !montoInput || !montoInput.value) return;
            
            const tipo = tipoSelect.options[tipoSelect.selectedIndex].text;
            const monto = parseFloat(montoInput.value) || 0;
            
            // Agregar a la tabla de resumen
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${tipo}</td>
                <td class="text-end">$${monto.toFixed(2)}</td>
            `;
            resumenItems.appendChild(row);
            
            // Sumar al total
            total += monto;
            
            // Guardar para el gráfico
            itemsData.push({
                tipo: tipo,
                monto: monto
            });
        });
        
        // Actualizar el total
        document.getElementById('resumen-total').textContent = `$${total.toFixed(2)}`;
        
        // Actualizar el gráfico
        actualizarGrafico(itemsData);
    }
    
    // Función para actualizar el gráfico
    function actualizarGrafico(itemsData) {
        // Agrupar por tipo
        const tiposAgrupados = {};
        itemsData.forEach(item => {
            if (!tiposAgrupados[item.tipo]) {
                tiposAgrupados[item.tipo] = 0;
            }
            tiposAgrupados[item.tipo] += item.monto;
        });

        // Preparar datos para el gráfico
        const labels = Object.keys(tiposAgrupados);
        const data = Object.values(tiposAgrupados);

        // Colores para el gráfico
        const colores = [
            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
            '#5a5c69', '#858796', '#6f42c1', '#20c9a6', '#fd7e14'
        ];

        // Obtener el contexto del canvas
        const ctx = document.getElementById('items-chart').getContext('2d');

        // Destruir el gráfico anterior si existe
        if (window.itemsChart) {
            window.itemsChart.destroy();
        }

        // Crear el nuevo gráfico
        window.itemsChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colores.slice(0, labels.length),
                    borderColor: '#ffffff',
                    borderWidth: 2,
                    hoverBorderColor: '#ffffff',
                    hoverBorderWidth: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: {
                                size: 14
                            }
                        }
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeInOutQuart'
                }
            }
        });

        // Actualizar la leyenda del gráfico
        const legend = document.getElementById('chart-legend');
        legend.innerHTML = window.itemsChart.generateLegend();
    }
</script>
{% endblock extra_js %}

