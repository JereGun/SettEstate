{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{% if form.instance.pk %}Editar{% else %}Nueva{% endif %} Propiedad - SettEstate{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'index' %}">Inicio</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'propiedad_list' %}">Propiedades</a></li>
                    <li class="breadcrumb-item active">{% if form.instance.pk %}Editar{% else %}Nueva{% endif %} Propiedad</li>
                </ol>
            </nav>

            <!-- Card principal -->
            <div class="card shadow-lg border-0 rounded-lg">
                <div class="card-header bg-gradient-primary-to-secondary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-building me-2"></i>
                            {% if form.instance.pk %}Editar{% else %}Nueva{% endif %} Propiedad
                        </h3>
                        {% if form.instance.pk %}
                        <span class="badge bg-light text-dark">ID: {{ form.instance.pk }}</span>
                        {% endif %}
                    </div>
                </div>
                
                <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                    {% csrf_token %}
                    
                    <div class="card-body">
                        {% crispy form %}
                        
                        <div class="border-top pt-4 mt-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4 class="mb-0">
                                    <i class="fas fa-images me-2"></i>
                                    Imágenes de la Propiedad
                                </h4>
                                <button type="button" 
                                        class="btn btn-sm btn-outline-primary" 
                                        id="add-imagen">
                                    <i class="fas fa-plus me-1"></i> Agregar Imagen
                                </button>
                            </div>
                            
                            {{ formset.management_form }}
                            <div id="imagenes-container" class="row g-3">
                                {% for imagen_form in formset %}
                                    <div class="col-md-12">
                                        <div class="imagen-form card border-0 shadow-sm">
                                            <div class="card-body">
                                                <div class="row align-items-center">
                                                    {% if imagen_form.instance.pk %}
                                                    <div class="col-md-3">
                                                        <div class="preview-container mb-2">
                                                            <img src="{{ imagen_form.instance.imagen.url }}" 
                                                                class="img-thumbnail" 
                                                                style="max-height: 150px;">
                                                        </div>
                                                    </div>
                                                    <div class="col-md-9">
                                                    {% else %}
                                                    <div class="col-md-12">
                                                    {% endif %}
                                                        {% crispy imagen_form %}
                                                        
                                                        {% if imagen_form.instance.pk %}
                                                        <div class="form-check mt-2">
                                                            {{ imagen_form.DELETE }}
                                                            <label class="form-check-label text-danger">
                                                                <i class="fas fa-trash-alt me-1"></i> Eliminar imagen
                                                            </label>
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-footer bg-light">
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'propiedad_list' %}" 
                               class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i> Volver
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>
                                {% if form.instance.pk %}
                                    Actualizar Propiedad
                                {% else %}
                                    Crear Propiedad
                                {% endif %}
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Tarjeta de ayuda -->
            <div class="card mt-4 border-0 shadow-sm bg-light">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-lightbulb text-warning me-2"></i>
                        Consejos para completar el formulario
                    </h5>
                    <ul class="mb-0">
                        <li>Incluya una descripción detallada para mejorar la visibilidad de la propiedad.</li>
                        <li>Agregue múltiples imágenes de alta calidad para mostrar todos los aspectos de la propiedad.</li>
                        <li>Marque al menos una imagen como principal para que aparezca destacada en los listados.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_css %}
<style>
    /* Estilos para el formulario */
    .bg-gradient-primary-to-secondary {
        background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
    }
    
    .imagen-form {
        transition: all 0.3s ease;
    }
    
    .imagen-form:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }
    
    .preview-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 150px;
        background-color: #f8f9fa;
        border-radius: 0.25rem;
        overflow: hidden;
    }
    
    .invalid-feedback {
        display: block;
    }
    
    /* Estilos para las pestañas */
    .nav-tabs .nav-link {
        border: none;
        color: #495057;
        font-weight: 500;
        padding: 1rem 1.5rem;
    }
    
    .nav-tabs .nav-link.active {
        color: #3498db;
        border-bottom: 3px solid #3498db;
        background-color: transparent;
    }
    
    .tab-content {
        padding: 1.5rem 0;
    }
    
    /* Mejoras para campos pequeños */
    .form-group {
        margin-bottom: 1rem;
    }
    
    /* Campos de tipo checkbox con mejor alineación */
    .form-check {
        display: flex;
        align-items: center;
        height: 100%;
    }
    
    .form-check-input {
        margin-top: 0;
    }
    
    /* Animaciones */
    .card, .btn {
        transition: all 0.3s ease;
    }
    
    .btn:hover {
        transform: translateY(-2px);
    }
    
    /* Estilos para el mapa */
    #map {
        border-radius: 8px;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    /* Mejora visual para los fieldsets */
    fieldset {
        margin-bottom: 2rem;
    }
    
    legend {
        font-size: 1.1rem;
        font-weight: 600;
        color: #3498db;
        border-bottom: 1px solid #e9ecef;
        width: 100%;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar mapa si existe el elemento
    if (document.getElementById('map')) {
        const map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: -34.603722, lng: -58.381592 }, // Buenos Aires por defecto
            zoom: 13
        });
        
        // Si hay dirección, intentar geocodificarla
        const calleInput = document.querySelector('input[name="calle"]');
        const numeracionInput = document.querySelector('input[name="numeracion"]');
        const ciudadInput = document.querySelector('input[name="ciudad"]');
        
        if (calleInput && numeracionInput && ciudadInput) {
            const geocoder = new google.maps.Geocoder();
            const updateMap = () => {
                const calle = calleInput.value;
                const numeracion = numeracionInput.value;
                const ciudad = ciudadInput.value;
                
                if (calle && numeracion && ciudad) {
                    geocoder.geocode({ 'address': `${calle} ${numeracion}, ${ciudad}` }, function(results, status) {
                        if (status === 'OK') {
                            map.setCenter(results[0].geometry.location);
                            new google.maps.Marker({
                                map: map,
                                position: results[0].geometry.location
                            });
                        }
                    });
                }
            };
            
            // Actualizar mapa cuando cambian los campos
            calleInput.addEventListener('change', updateMap);
            numeracionInput.addEventListener('change', updateMap);
            ciudadInput.addEventListener('change', updateMap);
            
            // Intentar geocodificar dirección inicial
            if (calleInput.value && numeracionInput.value && ciudadInput.value) {
                updateMap();
            }
        }
    }

    // Función para inicializar la vista previa de imagen
    function initializeImagePreview(imageInput) {
        imageInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                const formContainer = this.closest('.imagen-form');
                let previewContainer = formContainer.querySelector('.preview-container');
                
                if (!previewContainer) {
                    previewContainer = document.createElement('div');
                    previewContainer.className = 'preview-container mb-2';
                    const img = document.createElement('img');
                    img.className = 'img-thumbnail';
                    img.style.maxHeight = '150px';
                    previewContainer.appendChild(img);
                    
                    // Insertar antes del primer elemento hijo
                    const rowElement = formContainer.querySelector('.row');
                    const firstColumn = rowElement.querySelector('.col-md-12, .col-md-9');
                    
                    // Crear nueva columna para la vista previa
                    const previewCol = document.createElement('div');
                    previewCol.className = 'col-md-3';
                    previewCol.appendChild(previewContainer);
                    
                    // Ajustar el tamaño de la columna existente
                    firstColumn.className = 'col-md-9';
                    
                    // Insertar la columna de vista previa antes de la columna existente
                    rowElement.insertBefore(previewCol, firstColumn);
                }
                
                const previewImage = previewContainer.querySelector('img');
                reader.onload = e => previewImage.src = e.target.result;
                reader.readAsDataURL(file);
            }
        });
    }

    // Inicializar todas las vistas previas existentes
    document.querySelectorAll('input[type="file"]').forEach(initializeImagePreview);

    // Manejar el botón de agregar imagen
    const addButton = document.getElementById('add-imagen');
    const totalForms = document.getElementById('id_imagenes-TOTAL_FORMS');
    
    addButton.addEventListener('click', function() {
        const formCount = parseInt(totalForms.value);
        const template = document.querySelector('.imagen-form').cloneNode(true);
        
        // Actualizar IDs y nombres
        template.querySelectorAll('[id^="id_imagenes-"], [name^="imagenes-"]').forEach(element => {
            element.id = element.id.replace(/-\d+-/, `-${formCount}-`);
            element.name = element.name.replace(/-\d+-/, `-${formCount}-`);
            if (element.type !== 'hidden') {
                element.value = '';
            }
        });

        // Limpiar vista previa si existe
        const existingPreview = template.querySelector('.preview-container');
        if (existingPreview) {
            existingPreview.closest('.col-md-3').remove();
            
            // Restaurar el ancho de la columna de datos
            const dataColumn = template.querySelector('.col-md-9');
            if (dataColumn) {
                dataColumn.className = 'col-md-12';
            }
        }

        // Inicializar nueva vista previa
        const newImageInput = template.querySelector('input[type="file"]');
        initializeImagePreview(newImageInput);

        // Crear contenedor para el nuevo formulario
        const newFormContainer = document.createElement('div');
        newFormContainer.className = 'col-md-12';
        newFormContainer.appendChild(template);

        // Agregar el nuevo formulario
        document.getElementById('imagenes-container').appendChild(newFormContainer);
        totalForms.value = formCount + 1;
        
        // Animar la entrada del nuevo formulario
        template.style.opacity = '0';
        setTimeout(() => {
            template.style.opacity = '1';
        }, 10);
    });
    
    // Validación del formulario
    const form = document.querySelector('form');
    form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        form.classList.add('was-validated');
    });
});
</script>
{% endblock %}
{% endblock %}
