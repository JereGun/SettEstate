{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{% if form.instance.pk %}Editar{% else %}Nueva{% endif %} Propiedad - SettEstate{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'index' %}">Inicio</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'propiedad_list' %}">Propiedades</a></li>
                    <li class="breadcrumb-item active">{% if form.instance.pk %}Editar{% else %}Nueva{% endif %} Propiedad</li>
                </ol>
            </nav>

            <!-- Card principal -->
            <div class="card shadow-lg border-0 rounded-lg">
                <div class="card-header bg-gradient-primary-to-secondary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-building me-2"></i>
                            {% if form.instance.pk %}Editar{% else %}Nueva{% endif %} Propiedad
                        </h3>
                        {% if form.instance.pk %}
                        <span class="badge bg-light text-dark">ID: {{ form.instance.pk }}</span>
                        {% endif %}
                    </div>
                </div>
                
                <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                    {% csrf_token %}
                    
                    <div class="card-body">
                        <!-- Sistema de pestañas -->
                        <ul class="nav nav-tabs" id="propiedadTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="info-basica-tab" data-bs-toggle="tab" data-bs-target="#info-basica" type="button" role="tab" aria-controls="info-basica" aria-selected="true">
                                    <i class="fas fa-info-circle me-1"></i> Información Básica
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="ubicacion-tab" data-bs-toggle="tab" data-bs-target="#ubicacion" type="button" role="tab" aria-controls="ubicacion" aria-selected="false">
                                    <i class="fas fa-map-marker-alt me-1"></i> Ubicación
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="contrato-tab" data-bs-toggle="tab" data-bs-target="#contrato" type="button" role="tab" aria-controls="contrato" aria-selected="false">
                                    <i class="fas fa-file-contract me-1"></i> Datos de Contrato
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="caracteristicas-tab" data-bs-toggle="tab" data-bs-target="#caracteristicas" type="button" role="tab" aria-controls="caracteristicas" aria-selected="false">
                                    <i class="fas fa-list-ul me-1"></i> Características
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="imagenes-tab" data-bs-toggle="tab" data-bs-target="#imagenes" type="button" role="tab" aria-controls="imagenes" aria-selected="false">
                                    <i class="fas fa-images me-1"></i> Imágenes
                                </button>
                            </li>
                        </ul>
                        
                        <!-- Contenido de las pestañas -->
                        <div class="tab-content pt-4" id="propiedadTabsContent">
                            <!-- Información Básica -->
                            <div class="tab-pane fade show active" id="info-basica" role="tabpanel" aria-labelledby="info-basica-tab">
                                <div class="row">
                                    <div class="col-md-6">
                                        {{ form.denominacion|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ form.tipo|as_crispy_field }}
                                    </div>
                                    <div class="col-md-12">
                                        {{ form.descripcion|as_crispy_field }}
                                    </div>
                                    <div class="col-md-12">
                                        {{ form.dueño|as_crispy_field }}
                                    </div>
                                </div>
                                
                                <!-- Fechas de creación y modificación -->
                                {% if form.instance.pk %}
                                <div class="row mt-4">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Fecha de creación</label>
                                            <input type="text" class="form-control" value="{{ form.instance.creacion|date:'d/m/Y H:i' }}" readonly>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Última actualización</label>
                                            <input type="text" class="form-control" value="{{ form.instance.ultima_actualizacion|date:'d/m/Y H:i' }}" readonly>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Ubicación -->
                            <div class="tab-pane fade" id="ubicacion" role="tabpanel" aria-labelledby="ubicacion-tab">
                                <div class="row">
                                    <div class="col-md-6">
                                        {{ form.calle|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ form.numeracion|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ form.piso|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ form.departamento|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ form.barrio|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ form.ciudad|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ form.provincia|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ form.pais|as_crispy_field }}
                                    </div>
                                </div>
                                
                                <!-- Mapa -->
                                <div class="mt-4">
                                    <label class="form-label">Ubicación en el mapa</label>
                                    <div id="map" style="height: 300px;"></div>
                                </div>
                            </div>
                            
                            <!-- Datos de Contrato -->
                            <div class="tab-pane fade" id="contrato" role="tabpanel" aria-labelledby="contrato-tab">
                                <div class="row">
                                    <div class="col-md-6">
                                        {{ form.disponible|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ form.alquiler_venta|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ form.precio_alquiler|as_crispy_field }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ form.precio_venta|as_crispy_field }}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Características -->
                            <div class="tab-pane fade" id="caracteristicas" role="tabpanel" aria-labelledby="caracteristicas-tab">
                                <div class="row">
                                    <div class="col-md-4">
                                        {{ form.baños|as_crispy_field }}
                                    </div>
                                    <div class="col-md-4">
                                        {{ form.dormitorios|as_crispy_field }}
                                    </div>
                                    <div class="col-md-4">
                                        {{ form.ambientes|as_crispy_field }}
                                    </div>
                                    <div class="col-md-4">
                                        {{ form.cocheras|as_crispy_field }}
                                    </div>
                                    <div class="col-md-4">
                                        {{ form.pisos|as_crispy_field }}
                                    </div>
                                    <div class="col-md-4">
                                        {{ form.antiguedad|as_crispy_field }}
                                    </div>
                                    <div class="col-md-4">
                                        {{ form.metros_cubiertos|as_crispy_field }}
                                    </div>
                                    <div class="col-md-4">
                                        {{ form.metros_descubiertos|as_crispy_field }}
                                    </div>
                                    <div class="col-md-4">
                                        {{ form.metros_totales|as_crispy_field }}
                                    </div>
                                    <div class="col-md-4">
                                        {{ form.piscina|as_crispy_field }}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Imágenes -->
                            <div class="tab-pane fade" id="imagenes" role="tabpanel" aria-labelledby="imagenes-tab">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h4 class="mb-0">
                                        <i class="fas fa-images me-2"></i>
                                        Imágenes de la Propiedad
                                    </h4>
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-primary" 
                                            id="add-imagen">
                                        <i class="fas fa-plus me-1"></i> Agregar Imagen
                                    </button>
                                </div>
                                
                                {{ formset.management_form }}
                                <div id="imagenes-container" class="row g-3">
                                    {% for imagen_form in formset %}
                                        <div class="col-md-12">
                                            <div class="imagen-form card border-0 shadow-sm">
                                                <div class="card-body">
                                                    <div class="row align-items-center">
                                                        {% if imagen_form.instance.pk %}
                                                        <div class="col-md-3">
                                                            <div class="preview-container mb-2">
                                                                <img src="{{ imagen_form.instance.imagen.url }}" 
                                                                    class="img-thumbnail" 
                                                                    style="max-height: 150px;">
                                                            </div>
                                                        </div>
                                                        <div class="col-md-9">
                                                        {% else %}
                                                        <div class="col-md-12">
                                                        {% endif %}
                                                            {% crispy imagen_form %}
                                                            
                                                            {% if imagen_form.instance.pk %}
                                                            <div class="form-check mt-2">
                                                                {{ imagen_form.DELETE }}
                                                                <label class="form-check-label text-danger">
                                                                    <i class="fas fa-trash-alt me-1"></i> Eliminar imagen
                                                                </label>
                                                            </div>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-footer bg-light">
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'propiedad_list' %}" 
                               class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i> Volver
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>
                                {% if form.instance.pk %}
                                    Actualizar Propiedad
                                {% else %}
                                    Crear Propiedad
                                {% endif %}
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Tarjeta de ayuda -->
            <div class="card mt-4 border-0 shadow-sm bg-light">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-lightbulb text-warning me-2"></i>
                        Consejos para completar el formulario
                    </h5>
                    <ul class="mb-0">
                        <li>Incluya una descripción detallada para mejorar la visibilidad de la propiedad.</li>
                        <li>Agregue múltiples imágenes de alta calidad para mostrar todos los aspectos de la propiedad.</li>
                        <li>Marque al menos una imagen como principal para que aparezca destacada en los listados.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_css %}
<style>
    /* Estilos para el formulario */
    .bg-gradient-primary-to-secondary {
        background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
    }
    
    .imagen-form {
        transition: all 0.3s ease;
    }
    
    .imagen-form:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }
    
    .preview-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 150px;
        background-color: #f8f9fa;
        border-radius: 0.25rem;
        overflow: hidden;
    }
    
    .invalid-feedback {
        display: block;
    }
    
    /* Estilos para las pestañas */
    .nav-tabs {
        border-bottom: 1px solid #dee2e6;
    }
    
    .nav-tabs .nav-link {
        border: none;
        color: #495057;
        font-weight: 500;
        padding: 1rem 1.5rem;
        margin-bottom: -1px;
        transition: all 0.2s ease;
    }
    
    .nav-tabs .nav-link:hover {
        color: #3498db;
        border-bottom: 3px solid #e9ecef;
    }
    
    .nav-tabs .nav-link.active {
        color: #3498db;
        border-bottom: 3px solid #3498db;
        background-color: transparent;
    }
    
    .tab-content {
        padding: 1.5rem 0;
    }
    
    /* Mejoras para campos pequeños */
    .form-group {
        margin-bottom: 1rem;
    }
    
    /* Campos de tipo checkbox con mejor alineación */
    .form-check {
        display: flex;
        align-items: center;
        height: 100%;
    }
    
    .form-check-input {
        margin-top: 0;
    }
    
    /* Animaciones */
    .card, .btn {
        transition: all 0.3s ease;
    }
    
    .btn:hover {
        transform: translateY(-2px);
    }
    
    /* Estilos para el mapa */
    #map {
        border-radius: 8px;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    /* Mejora visual para los fieldsets */
    fieldset {
        margin-bottom: 2rem;
    }
    
    legend {
        font-size: 1.1rem;
        font-weight: 600;
        color: #3498db;
        border-bottom: 1px solid #e9ecef;
        width: 100%;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
    }
    
    /* Estilos para las fechas de creación/modificación */
    .form-control[readonly] {
        background-color: #f8f9fa;
        cursor: default;
    }
    
    /* Animación para cambio de pestañas */
    .tab-pane.fade {
        transition: opacity 0.15s linear;
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Manejo de pestañas
    const triggerTabList = document.querySelectorAll('#propiedadTabs button');
    triggerTabList.forEach(triggerEl => {
        triggerEl.addEventListener('click', event => {
            event.preventDefault();
            const tab = new bootstrap.Tab(triggerEl);
            tab.show();
            
            // Guardar la pestaña activa en localStorage
            localStorage.setItem('activePropertyTab', triggerEl.getAttribute('id'));
        });
    });

    // Restaurar la pestaña activa al cargar la página
    const activeTab = localStorage.getItem('activePropertyTab');
    if (activeTab) {
        const tabToActivate = document.getElementById(activeTab);
        if (tabToActivate) {
            const tab = new bootstrap.Tab(tabToActivate);
            tab.show();
        }
    }
    
    // Si hay errores en el formulario, activar la pestaña correspondiente
    const formErrors = document.querySelectorAll('.is-invalid');
    if (formErrors.length > 0) {
        // Encontrar la pestaña que contiene el primer error
        const firstError = formErrors[0];
        const tabPane = firstError.closest('.tab-pane');
        if (tabPane) {
            const tabId = tabPane.id;
            const tabToActivate = document.querySelector(`[data-bs-target="#${tabId}"]`);
            if (tabToActivate) {
                const tab = new bootstrap.Tab(tabToActivate);
                tab.show();
            }
        }
    }

    // Inicializar mapa si existe el elemento
    if (document.getElementById('map')) {
        const map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: -34.603722, lng: -58.381592 }, // Buenos Aires por defecto
            zoom: 13
        });
        
        // Si hay dirección, intentar geocodificarla
        const calleInput = document.querySelector('input[name="calle"]');
        const numeracionInput = document.querySelector('input[name="numeracion"]');
        const ciudadInput = document.querySelector('input[name="ciudad"]');
        
        if (calleInput && numeracionInput && ciudadInput) {
            const geocoder = new google.maps.Geocoder();
            const updateMap = () => {
                const calle = calleInput.value;
                const numeracion = numeracionInput.value;
                const ciudad = ciudadInput.value;
                
                if (calle && numeracion && ciudad) {
                    geocoder.geocode({ 'address': `${calle} ${numeracion}, ${ciudad}` }, function(results, status) {
                        if (status === 'OK') {
                            map.setCenter(results[0].geometry.location);
                            new google.maps.Marker({
                                map: map,
                                position: results[0].geometry.location
                            });
                        }
                    });
                }
            };
            
            // Actualizar mapa cuando cambian los campos
            calleInput.addEventListener('change', updateMap);
            numeracionInput.addEventListener('change', updateMap);
            ciudadInput.addEventListener('change', updateMap);
            
            // Intentar geocodificar dirección inicial
            if (calleInput.value && numeracionInput.value && ciudadInput.value) {
                updateMap();
            }
        }
    }

    // Función para inicializar la vista previa de imagen
    function initializeImagePreview(imageInput) {
        imageInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                const formContainer = this.closest('.imagen-form');
                let previewContainer = formContainer.querySelector('.preview-container');
                
                if (!previewContainer) {
                    previewContainer = document.createElement('div');
                    previewContainer.className = 'preview-container mb-2';
                    const img = document.createElement('img');
                    img.className = 'img-thumbnail';
                    img.style.maxHeight = '150px';
                    previewContainer.appendChild(img);
                    
                    // Insertar antes del primer elemento hijo
                    const rowElement = formContainer.querySelector('.row');
                    const firstColumn = rowElement.querySelector('.col-md-12, .col-md-9');
                    
                    // Crear nueva columna para la vista previa
                    const previewCol = document.createElement('div');
                    previewCol.className = 'col-md-3';
                    previewCol.appendChild(previewContainer);
                    
                    // Ajustar el tamaño de la columna existente
                    firstColumn.className = 'col-md-9';
                    
                    // Insertar la columna de vista previa antes de la columna existente
                    rowElement.insertBefore(previewCol, firstColumn);
                }
                
                const previewImage = previewContainer.querySelector('img');
                reader.onload = e => previewImage.src = e.target.result;
                reader.readAsDataURL(file);
            }
        });
    }

    // Inicializar todas las vistas previas existentes
    document.querySelectorAll('input[type="file"]').forEach(initializeImagePreview);

    // Manejar el botón de agregar imagen
    const addButton = document.getElementById('add-imagen');
    const totalForms = document.getElementById('id_imagenes-TOTAL_FORMS');
    
    addButton.addEventListener('click', function() {
        const formCount = parseInt(totalForms.value);
        const template = document.querySelector('.imagen-form').cloneNode(true);
        
        // Actualizar IDs y nombres
        template.querySelectorAll('[id^="id_imagenes-"], [name^="imagenes-"]').forEach(element => {
            element.id = element.id.replace(/-\d+-/, `-${formCount}-`);
            element.name = element.name.replace(/-\d+-/, `-${formCount}-`);
            if (element.type !== 'hidden') {
                element.value = '';
            }
        });

        // Limpiar vista previa si existe
        const existingPreview = template.querySelector('.preview-container');
        if (existingPreview) {
            existingPreview.closest('.col-md-3').remove();
            
            // Restaurar el ancho de la columna de datos
            const dataColumn = template.querySelector('.col-md-9');
            if (dataColumn) {
                dataColumn.className = 'col-md-12';
            }
        }

        // Inicializar nueva vista previa
        const newImageInput = template.querySelector('input[type="file"]');
        initializeImagePreview(newImageInput);

        // Crear contenedor para el nuevo formulario
        const newFormContainer = document.createElement('div');
        newFormContainer.className = 'col-md-12';
        newFormContainer.appendChild(template);

        // Agregar el nuevo formulario
        document.getElementById('imagenes-container').appendChild(newFormContainer);
        totalForms.value = formCount + 1;
        
        // Animar la entrada del nuevo formulario
        template.style.opacity = '0';
        setTimeout(() => {
            template.style.opacity = '1';
        }, 10);
    });
    
    // Validación del formulario
    const form = document.querySelector('form');
    form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        form.classList.add('was-validated');
    });
});
</script>
{% endblock %}
{% endblock %}
